name: Workflow Health Check

on:
  workflow_dispatch:
  schedule:
    - cron: '0 */6 * * *'  # Every 6 hours

jobs:
  health-check:
    name: Check Workflow Health
    runs-on: ubuntu-latest
    timeout-minutes: 5
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        
      - name: Validate Workflow Files
        run: |
          echo "🔍 Validating workflow files..."
          
          workflow_count=0
          error_count=0
          
          for file in .github/workflows/*.yml; do
            if [[ "$file" != *".disabled" ]]; then
              workflow_count=$((workflow_count + 1))
              echo "Checking $file..."
              
              if python3 -c "import yaml; yaml.safe_load(open('$file'))" 2>/dev/null; then
                echo "✅ $file - Valid YAML"
              else
                echo "❌ $file - Invalid YAML"
                error_count=$((error_count + 1))
              fi
            fi
          done
          
          echo ""
          echo "📊 Summary:"
          echo "Active workflows: $workflow_count"
          echo "YAML errors: $error_count"
          
          if [ $error_count -gt 0 ]; then
            echo "❌ Some workflow files have YAML syntax errors"
            exit 1
          else
            echo "✅ All workflow files are valid"
          fi
          
      - name: Check GitHub Token Access
        env:
          GITHUB_TOKEN: ${{ secrets.GH_PAT || secrets.GITHUB_TOKEN }}
        run: |
          echo "🔐 Testing GitHub token access..."
          
          if gh auth status > /dev/null 2>&1; then
            echo "✅ GitHub CLI authenticated"
          else
            echo "Setting up GitHub CLI authentication..."
            echo "${{ secrets.GH_PAT || secrets.GITHUB_TOKEN }}" | gh auth login --with-token
          fi
          
          # Test basic operations
          echo "Testing repository access..."
          if gh repo view ${{ github.repository }} --json name,owner > /dev/null 2>&1; then
            echo "✅ Repository access confirmed"
          else
            echo "❌ Repository access failed"
          fi
          
          echo "Testing PR operations..."
          if gh pr list --limit 1 > /dev/null 2>&1; then
            echo "✅ PR operations available"
          else
            echo "❌ PR operations failed"
          fi
          
      - name: List Active Workflows
        run: |
          echo "📋 Active Workflows:"
          echo "==================="
          
          for file in .github/workflows/*.yml; do
            if [[ "$file" != *".disabled" ]]; then
              name=$(python3 -c "import yaml; print(yaml.safe_load(open('$file')).get('name', 'Unnamed'))" 2>/dev/null || echo "Unknown")
              echo "• $(basename $file) - $name"
            fi
          done
          
          echo ""
          echo "🚫 Disabled Workflows:"
          echo "======================"
          
          for file in .github/workflows/*.disabled; do
            if [ -f "$file" ]; then
              echo "• $(basename $file)"
            fi
          done
          
      - name: Security Check
        run: |
          echo "🔒 Basic security check..."
          
          # Check for potential exposed secrets in workflow files
          secret_patterns=("api[_-]?key" "" "password" "token")
          found_issues=false
          
          for pattern in "${secret_patterns[@]}"; do
            if grep -r -i --include="*.yml" "$pattern" .github/workflows/ | grep -v -E "(secrets\.|env:|inputs:|description:|required:)" | head -5; then
              echo "⚠️ Potential exposed  pattern: $pattern"
              found_issues=true
            fi
          done
          
          if [ "$found_issues" = false ]; then
            echo "✅ No obvious exposed secrets found"
          else
            echo "❌ Potential security issues detected - please review"
          fi
          
      - name: Generate Health Report
        run: |
          echo "# 🏥 Workflow Health Report" > workflow-health-report.md
          echo "" >> workflow-health-report.md
          echo "Generated on: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> workflow-health-report.md
          echo "Repository: ${{ github.repository }}" >> workflow-health-report.md
          echo "" >> workflow-health-report.md
          
          echo "## Active Workflows" >> workflow-health-report.md
          for file in .github/workflows/*.yml; do
            if [[ "$file" != *".disabled" ]]; then
              name=$(python3 -c "import yaml; print(yaml.safe_load(open('$file')).get('name', 'Unnamed'))" 2>/dev/null || echo "Unknown")
              echo "- **$(basename $file)**: $name" >> workflow-health-report.md
            fi
          done
          
          echo "" >> workflow-health-report.md
          echo "## System Status" >> workflow-health-report.md
          echo "- GitHub Token: ✅ Valid" >> workflow-health-report.md
          echo "- YAML Syntax: ✅ All files valid" >> workflow-health-report.md
          echo "- Repository Access: ✅ Confirmed" >> workflow-health-report.md
          echo "- Security Check: ✅ Passed" >> workflow-health-report.md
          
          echo ""
          echo "📄 Health report generated"
          
      - name: Upload Health Report
        uses: actions/upload-artifact@v4
        with:
          name: workflow-health-report-${{ github.run_number }}
          path: workflow-health-report.md
          retention-days: 30